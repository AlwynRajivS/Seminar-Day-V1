<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script src="common.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Poppins, sans-serif; padding: 20px; background: #f9fafc; }
    h2 { color: #333; }
    section { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 0 8px rgba(0,0,0,0.05); }
    button { background: #4285f4; color: white; border: none; padding: 8px 15px; border-radius: 8px; margin: 5px; cursor: pointer; }
    button:hover { background: #3367d6; }
    input[type=file] { margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #e8f0fe; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Admin Dashboard</h2>

  <section>
    <h3>Lock / Unlock Marks Entry (by Batch)</h3>
    <label><b>Select Batch:</b></label>
    <select id="batchSelect">
      <option value="">-- Select Batch --</option>
      <option value="FN">FN</option>
      <option value="AN">AN</option>
    </select><br><br>
    <button onclick="toggleLock('Open')">Unlock Marks Entry</button>
    <button onclick="toggleLock('Closed')">Lock Marks Entry</button>
    <div id="status"></div>
  </section>

  <section>
    <h3>Upload Data Sheets</h3>
    <div>
      <label><b>Download Templates:</b></label><br>
      <button onclick="downloadStaticTemplate('student')">Student Details Template</button>
      <button onclick="downloadStaticTemplate('faculty')">Faculty Login Template</button>
    </div>

    <div>
      <label><b>Student Details Sheet:</b></label><br>
      <input type="file" id="studentSheet" accept=".xlsx,.xls,.csv">
      <button onclick="uploadSheet('studentSheet', 'uploadStudentSheet')">Upload</button>
    </div>

    <div>
      <label><b>Faculty Login Details Sheet:</b></label><br>
      <input type="file" id="facultySheet" accept=".xlsx,.xls,.csv">
      <button onclick="uploadSheet('facultySheet', 'uploadFacultySheet')">Upload</button>
    </div>
    <div id="uploadStatus"></div>
  </section>

  <section>
    <h4>Download Reports</h4>
    <select id="deptSelect"></select>
    <select id="reportBatch">
      <option value="FN">FN</option>
      <option value="AN">AN</option>
    </select>
    <button onclick="downloadDeptReport()">Report (PDF)</button>
    <button onclick="downloadDeptReportCSV()">Department Report (CSV)</button>
    <button onclick="downloadTotalDeptReport()">Total Report (PDF)</button>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", populateDeptDropdown);

    function downloadStaticTemplate(type) {
      let csvContent = "";
      if (type === "student") {
        csvContent = 
`TeamID,Student1_ID,Student1_Name,Student2_ID,Student2_Name,Dept,Title,Venue,Batch
T001,22CS001,Anushaa P S,22CS002,Anu,CSE,AI-Based Traffic Control,Hall-1,FN`;
      } else if (type === "faculty") {
        csvContent = 
`Faculty_ID,Name,Password,Role,Venue,Batch
F001,Dr. xxx,pass123,Faculty,Hall-1,FN`;
      }

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = type === "student" ? "Student_Details_Template.csv" : "Faculty_Login_Template.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
    
    const normalize = v => String(v || "").trim().toLowerCase();

    async function toggleLock(status) {
      const batch = document.getElementById("batchSelect").value;
      if (!batch) return alert("Please select a batch first!");
      await postData("setLock", { batch, status });
      document.getElementById("status").textContent = `Marks entry for ${batch} batch is now ${status}`;
    }

    async function uploadSheet(inputId, functionName) {
      const fileInput = document.getElementById(inputId);
      const file = fileInput.files[0];
      if (!file) return alert("Please select a file before uploading!");
      const reader = new FileReader();
      reader.onload = async e => {
        await postData(functionName, { fileData: e.target.result, fileName: file.name });
        document.getElementById("uploadStatus").innerHTML = `${file.name} uploaded successfully.`;
        if (functionName === "uploadStudentSheet") populateDeptDropdown();
      };
      reader.readAsDataURL(file);
    }

    async function populateDeptDropdown() {
      const students = await postData("getStudents", { venue: "ALL" });
      const deptSelect = document.getElementById("deptSelect");
      deptSelect.innerHTML = "";

      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = "All Departments";
      deptSelect.appendChild(allOpt);

      const depts = [...new Set(students.map(s => s.Dept || s.dept || "").filter(d => d))];
      depts.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        deptSelect.appendChild(opt);
      });
    }

async function getLogoData() {
  const logoUrl = "logo.jpeg"; // make sure this path is correct
  try {
    const resp = await fetch(logoUrl);
    if (!resp.ok) throw new Error("Logo not found");
    const blob = await resp.blob();
    const bitmap = await createImageBitmap(blob);
    const canvas = document.createElement("canvas");
    canvas.width = bitmap.width;
    canvas.height = bitmap.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(bitmap, 0, 0);
    return canvas.toDataURL("image/jpeg");
  } catch (e) {
    console.warn("Logo load failed:", e);
    return null;
  }
}

// === Department Report (PDF) ===
async function downloadDeptReport() {
  const dept = document.getElementById("deptSelect").value;
  const batch = document.getElementById("reportBatch").value;

  // Fetch marks data from backend
  const marksResp = await postData("getMarks", { batch });
  const marks = Array.isArray(marksResp) ? marksResp : marksResp.data || [];

  console.log("Marks fetched:", marks);

  // Filter department-wise
  const filtered =
    dept === "ALL"
      ? marks
      : marks.filter(
          (m) => (m.Dept || "").trim().toLowerCase() === dept.trim().toLowerCase()
        );

  if (!filtered.length) {
    alert("No marks data found for this department.");
    return;
  }

  // Prepare PDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape", "pt", "a4");
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const logoData = await getLogoData();
  const generatedDate = new Date().toLocaleString();

  // ====== Header ======
  //if (logoData) {
    //doc.addImage(logoData, "JPEG", 40, 25, 80, 80);
  //}

  doc.setFont("times", "bold");
  doc.setFontSize(18);
  doc.text("SEMINAR DAY EVALUATION REPORT", pageWidth / 2, 100, { align: "center" });

  doc.setFontSize(12);
  doc.text(`Department: ${dept}`, 60, 120);
  doc.text(`Batch: ${batch}`, pageWidth - 120, 120);

  // ====== Table Header and Data ======
  const head = [
    [
      "Faculty ID",
      "Team ID",
      "Student ID",
      "Student Name",
      "Dept",
      "Venue",
      "Level I - Problem",
      "Level I - Methodology",
      "Level I - Pictorial",
      "Level I - Response",
      "Level II - Determination",
      "Level II - Communication",
      "Total",
    ],
  ];

  const body = filtered.map((m) => [
    m.Faculty_ID || "",
    m.TeamID || "",
    m.Student_ID || "",
    m.Student_Name || "",
    m.Dept || "",
    m.Venue || "",
    m.LevelI_Problem || 0,
    m.LevelI_Methodology || 0,
    m.LevelI_Pictorial || 0,
    m.LevelI_Response || 0,
    m.LevelII_Determination || 0,
    m.LevelII_Communication || 0,
    m.Total || 0,
  ]);

  const headerHeight = 150;

  // ====== Table ======
  doc.autoTable({
    head: head,
    body: body,
    startY: headerHeight,
    theme: "grid",
    styles: {
      font: "times",
      fontSize: 10,
      textColor: 0,
      cellPadding: 4,
      lineColor: 0,
      lineWidth: 0.5,
      halign: "center",
      valign: "middle",
    },
    headStyles: {
      fillColor: [255, 255, 255],
      textColor: 0,
      lineColor: 0,
      lineWidth: 0.5,
      halign: "center",
      valign: "middle"
    },
    columnStyles: {
      3: { halign: "left" }, // Student Name aligned left for readability
    },
    didDrawPage: function (data) {
      if (logoData) {
        const logoWidth = 250, logoHeight = 50;
        doc.addImage(logoData, "JPEG", (pageWidth - logoWidth) / 2, 20, logoWidth, logoHeight);
      }
    },
  });

  const finalY = doc.lastAutoTable.finalY + 60;
  doc.setFontSize(12);
  doc.setFont("times", "bold");

  if (dept === "ALL") {
    // Only Dean Academic Courses (right side)
    doc.text("Dean Academic Courses", pageWidth - 52, finalY + 90, { align: "right" });
  } else {
    // HoD (left side) + Dean Academic Courses (right side)
    doc.text("HoD", 80, finalY + 90);
    doc.text("Dean Academic Courses", pageWidth - 52, finalY + 90, { align: "right" });
  }
  doc.setFont("times", "normal");
  doc.text(`Generated on: ${generatedDate}`, 630, pageHeight - 150);
  // ====== Save PDF ======
  doc.save(`${dept}_${batch}_Seminar_Report.pdf`);
}

    // === Department CSV Download ===
    // ðŸ”¹ Download Department Report as CSV
async function downloadDeptReportCSV() {
  const dept = document.getElementById("deptSelect").value;
  const batch = document.getElementById("reportBatch").value;

  // Fetch marks from Apps Script backend
  const marksResp = await postData("getMarks", { batch });
  const marks = Array.isArray(marksResp) ? marksResp : marksResp.data || [];

  console.log("Marks fetched:", marks);

  // Filter department-wise
  const filtered = dept === "ALL"
    ? marks
    : marks.filter(
        (m) =>
          (m.Dept || "").trim().toLowerCase() === dept.trim().toLowerCase()
      );

  if (!filtered.length)
    return alert("No marks data found for this department.");

  // Header columns (match your sheet)
  const header = [
    "Faculty_ID",
    "TeamID",
    "Student_ID",
    "Student_Name",
    "Dept",
    "Venue",
    "LevelI_Problem",
    "LevelI_Methodology",
    "LevelI_Pictorial",
    "LevelI_Response",
    "LevelII_Determination",
    "LevelII_Communication",
    "Total",
    "Batch",
  ];

  // Construct CSV content
  let csv = header.join(",") + "\n";
  filtered.forEach((m) => {
    csv += [
      m.Faculty_ID || "",
      m.TeamID || "",
      m.Student_ID || "",
      m.Student_Name || "",
      m.Dept || "",
      m.Venue || "",
      m.LevelI_Problem || "",
      m.LevelI_Methodology || "",
      m.LevelI_Pictorial || "",
      m.LevelI_Response || "",
      m.LevelII_Determination || "",
      m.LevelII_Communication || "",
      m.Total || "",
      m.Batch || "",
    ].join(",") + "\n";
  });

  // Create and download CSV file
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${dept}_${batch}_Seminar_Report.csv`;
  a.click();
}

async function downloadTotalDeptReport() {
  const dept = document.getElementById("deptSelect").value;
  const batch = document.getElementById("reportBatch").value;

  // Fetch marks data from backend
  const marksResp = await postData("getMarks", { batch });
  const marks = Array.isArray(marksResp) ? marksResp : marksResp.data || [];

  console.log("Marks fetched:", marks);

  // Filter department-wise
  const filtered =
    dept === "ALL"
      ? marks
      : marks.filter(
          (m) => (m.Dept || "").trim().toLowerCase() === dept.trim().toLowerCase()
        );

  if (!filtered.length) {
    alert("No marks data found for this department.");
    return;
  }

  // === Group by Student_ID to calculate Mark1, Mark2, and Average ===
  const grouped = {};
  filtered.forEach((m) => {
    const sid = (m.Student_ID || "").trim();
    if (!sid) return;
    if (!grouped[sid]) {
      grouped[sid] = {
        Student_ID: sid,
        Student_Name: m.Student_Name || "",
        Dept: m.Dept || "",
        Marks: [],
      };
    }
    grouped[sid].Marks.push(Number(m.Total) || 0);
  });

  // Convert grouped data into table rows
  const combined = Object.values(grouped).map((s) => {
    const mark1 = s.Marks[0] || 0;
    const mark2 = s.Marks[1] || 0;
    const avg = Math.ceil((mark1 + mark2) / 2);
    return [
      s.Student_ID,
      s.Student_Name,
      s.Dept,
      mark1,
      mark2,
      avg,
    ];
  });

  // === Prepare PDF ===
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const logoData = await getLogoData();
  const generatedDate = new Date().toLocaleString();

  // ====== Header ======
  doc.setFont("times", "bold");
  doc.setFontSize(18);
  doc.text("SEMINAR DAY TOTAL REPORT", pageWidth / 2, 40, { align: "center" });

  doc.setFontSize(12);
  doc.text(`Department: ${dept}`, 20, 50);
  doc.text(`Batch: ${batch}`, pageWidth - 40, 50);

  // ====== Table ======
  const head = [["Student ID", "Student Name", "Dept", "Mark 1", "Mark 2", "Average"]];

  doc.autoTable({
    head,
    body: combined,
    startY: 60,
    theme: "grid",
    styles: {
      font: "times",
      fontSize: 10,
      textColor: 0,
      cellPadding: 2,
      lineColor: 0,
      lineWidth: 0.5,
      halign: "center",
      valign: "middle",
    },
    headStyles: {
      fillColor: [255, 255, 255],
      textColor: 0,
      lineColor: 0,
      lineWidth: 0.5,
      halign: "center",
      valign: "middle",
      fontStyle: "bold",
    },
    columnStyles: {
      1: { halign: "left" }, // Student Name aligned left
    },
    didDrawPage: function () {
      if (logoData) {
        const logoWidth = 100,
          logoHeight = 20;
        doc.addImage(logoData, "JPEG", (pageWidth - logoWidth) / 2, 10, logoWidth, logoHeight);
      }
    },
  });

  const finalY = doc.lastAutoTable.finalY + 60;
  doc.setFontSize(12);
  doc.setFont("times", "bold");

  if (dept === "ALL") {
    // Only Dean Academic Courses (right side)
    doc.text("Dean Academic Courses", pageWidth - 27, finalY + 90, { align: "right" });
  } else {
    // HoD (left side) + Dean Academic Courses (right side)
    doc.text("HoD", 30, finalY + 90);
    doc.text("Dean Academic Courses", pageWidth - 27, finalY + 90, { align: "right" });
  }

  // ====== Generated Timestamp ======
  doc.setFont("times", "normal");
  doc.setFontSize(10);
  doc.text(`Generated on: ${generatedDate}`, 135, pageHeight - 40);

  // ====== Save PDF ======
  doc.save(`${dept}_${batch}_Total_Seminar_Report.pdf`);
}

  </script>
</body>
</html>
