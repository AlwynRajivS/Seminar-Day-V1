<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty - Mark Entry</title>
<script src="common.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* ---------- Global ---------- */
* { box-sizing: border-box; }
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  background: #f3f7fa;
  color: #2c3e50;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h2 {
  width: 100%;
  background: linear-gradient(90deg, #0078d7, #00bfa5);
  color: #fff;
  text-align: center;
  padding: 14px 0;
  font-size: 22px;
  margin: 0;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

#welcome, #lockMsg {
  text-align: center;
  padding: 10px;
  font-size: 15px;
  line-height: 1.4;
  width: 95%;
  max-width: 700px;
}
#lockMsg b { color: red; }

#teamSelectBox {
  text-align: center;
  margin: 10px 0;
  width: 95%;
  max-width: 700px;
}

label { font-weight: 600; margin-right: 5px; }
select {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  width: 70%;
  max-width: 300px;
  transition: 0.3s;
}
select:focus {
  border-color: #0078d7;
  box-shadow: 0 0 5px rgba(0,120,215,0.3);
}

button {
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  background: linear-gradient(90deg, #28a745, #20c997);
  color: white;
  font-weight: 500;
  cursor: pointer;
  font-size: 14px;
  transition: 0.3s;
}
button:hover:not(:disabled) { transform: scale(1.05); }
button:disabled { background: #ccc; cursor: not-allowed; }

.table-container {
  width: 95%;
  max-width: 1000px;
  overflow-x: auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  margin-bottom: 40px;
  animation: fadeIn 0.5s ease;
}

table {
  border-collapse: collapse;
  width: 100%;
  min-width: 900px;
}
th, td {
  border: 1px solid #e0e0e0;
  padding: 8px;
  text-align: center;
  font-size: 13px;
}
thead tr:nth-child(1) th {
  background: #0078d7;
  color: white;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 1;
}
thead tr:nth-child(2) th {
  background: #eaf4fb;
  font-weight: normal;
}
.total {
  font-weight: bold;
  color: #0078d7;
}

@media (max-width: 768px) {
  /* Convert table to card layout */
  .table-container { overflow: visible; box-shadow: none; background: none; }
  table, thead, tbody, th, td, tr { display: block; }
  thead { display: none; }

  tbody tr {
    background: #fff;
    margin: 12px 0;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    animation: slideUp 0.4s ease;
  }

  tbody td {
    border: none;
    text-align: left;
    padding: 6px 8px;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  tbody td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #555;
    flex: 1;
  }

  select { width: 55%; font-size: 14px; }
  button { width: 100%; margin-top: 6px; }
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body onload="initFaculty()">
  <h2><i class="fa-solid fa-user-pen"></i> Faculty - Mark Entry</h2>
  <div id="welcome"></div>
  <div id="lockMsg"></div>

  <div id="teamSelectBox">
    <label><i class="fa-solid fa-people-group"></i> Select Team ID:</label>
    <select id="teamSelect"><option value="">-- Select Team --</option></select>
  </div>

  <div class="table-container">
    <table id="studentTable" style="display:none;">
      <thead>
        <tr>
          <th rowspan="2">Team ID</th>
          <th rowspan="2">Student Name</th>
          <th rowspan="2">Department</th>
          <th rowspan="2">Title</th>
          <th colspan="4">Level I (10 marks each)</th>
          <th colspan="2">Level II (30 marks each)</th>
          <th rowspan="2">Total</th>
          <th rowspan="2">Action</th>
        </tr>
        <tr>
          <th>Problem Statement / Theme</th>
          <th>Methodology / Proposed Solution</th>
          <th>Pictorial / Scientific Explanation</th>
          <th>Responding to Queries</th>
          <th>Determination / Confidence Level</th>
          <th>Communication</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/* ---------- Original JS (no logic change) ---------- */
const faculty_id = localStorage.getItem("faculty_id");
const venue = localStorage.getItem("venue");
const facultyName = localStorage.getItem("faculty_name");
const batch = localStorage.getItem("batch");

const level1Marks = { "Excellent":10,"Good":8,"Average":6,"Poor":4 };
const level2Marks = { "Excellent":30,"Good":24,"Average":18,"Poor":12 };

let students = [], existingMarks = [], locked = false;

async function initFaculty() {
  if (!faculty_id || !venue || !facultyName || !batch) {
    alert("Unauthorized access! Please login again.");
    window.location.href = "index.html"; return;
  }

  document.getElementById("welcome").innerHTML =
    `<i class='fa-solid fa-user'></i> Welcome <b>${facultyName}</b><br>
     <i class='fa-solid fa-location-dot'></i> Venue: <b>${venue}</b> |
     <i class='fa-solid fa-users'></i> Batch: <b>${batch}</b>`;

  const lockData = await postData("getLockStatus", { batch });
  locked = (lockData.status === "Closed");
  if (locked)
    document.getElementById("lockMsg").innerHTML =
      "<b><i class='fa-solid fa-lock'></i> Mark Entry Locked! You can only view marks.</b>";

  const studentRes = await postData("getStudents", { venue, batch });
  students = (Array.isArray(studentRes) ? studentRes : []).map(s => ({
    teamId: s.teamid || "",
    s1Id: s.student1_id || "",
    s1Name: s.student1_name || "",
    s2Id: s.student2_id || "",
    s2Name: s.student2_name || "",
    dept: s.dept || "",
    title: s.title || ""
  }));

  if (!students.length) alert("No students found for this venue/batch.");
  existingMarks = await postData("getFacultyMarks", { faculty_id, batch });
  populateTeamDropdown();
}

function populateTeamDropdown() {
  const teamSelect = document.getElementById("teamSelect");
  teamSelect.innerHTML = `<option value="">-- Select Team --</option>`;
  const uniqueTeams = [...new Set(students.map(s => s.teamId))];
  uniqueTeams.forEach(tid => {
    const opt = document.createElement("option");
    opt.value = tid; opt.textContent = tid;
    teamSelect.appendChild(opt);
  });
  teamSelect.onchange = handleTeamChange;
}

function handleTeamChange() {
  const selectedTeam = document.getElementById("teamSelect").value;
  const tbody = document.querySelector("#studentTable tbody"); 
  tbody.innerHTML = "";
  if (!selectedTeam) return document.getElementById("studentTable").style.display="none";

  const teamStudents = students.filter(s => s.teamId === selectedTeam);
  teamStudents.forEach(st => {
    if (st.s1Name) tbody.appendChild(createRow(st.teamId, st.s1Id, st.s1Name, st.dept, st.title));
    if (st.s2Name) tbody.appendChild(createRow(st.teamId, st.s2Id, st.s2Name, st.dept, st.title));
  });
  document.getElementById("studentTable").style.display = "table";
}

function createRow(team_id, student_id, student_name, dept, title) {
  const existing = existingMarks.find(m => String(m.student_id).trim() === String(student_id).trim());
  const row = document.createElement("tr");
  row.innerHTML = `
    <td data-label="Team ID">${team_id}</td>
    <td data-label="Student Name">${student_name}</td>
    <td data-label="Department">${dept}</td>
    <td data-label="Title">${title}</td>
    ${Array(4).fill('<td data-label="Level I"><select class="lvl1"><option>Excellent</option><option>Good</option><option>Average</option><option>Poor</option></select></td>').join('')}
    ${Array(2).fill('<td data-label="Level II"><select class="lvl2"><option>Excellent</option><option>Good</option><option>Average</option><option>Poor</option></select></td>').join('')}
    <td data-label="Total"><span class="total">0</span></td>
    <td data-label="Action"><button><i class="fa-solid fa-floppy-disk"></i> Save</button></td>`;

  const btn = row.querySelector("button");
  const selects = row.querySelectorAll("select");

  if(existing){
    const l1vals = [existing.l1_1, existing.l1_2, existing.l1_3, existing.l1_4].map(v => Number(v)||0);
    const l2vals = [existing.l2_1, existing.l2_2].map(v => Number(v)||0);
    selects.forEach((sel, idx)=>{
      if(idx<4) sel.value = getKeyByValue(level1Marks, l1vals[idx]);
      else sel.value = getKeyByValue(level2Marks, l2vals[idx-4]);
    });
  }

  updateTotal(row);
  if (locked) btn.disabled = true;
  else btn.onclick = () => saveMarks(row, team_id, student_id);

  selects.forEach(s => s.addEventListener("change", () => updateTotal(row)));
  return row;
}

function getKeyByValue(obj,val){
  val = Number(val);
  return Object.keys(obj).find(k => obj[k] === val) || "Excellent";
}

function updateTotal(row){
  const l1 = Array.from(row.querySelectorAll(".lvl1")).map(s=>level1Marks[s.value]);
  const l2 = Array.from(row.querySelectorAll(".lvl2")).map(s=>level2Marks[s.value]);
  row.querySelector(".total").textContent = l1.reduce((a,b)=>a+b,0) + l2.reduce((a,b)=>a+b,0);
}

async function saveMarks(row,team_id,student_id){
  const l1 = Array.from(row.querySelectorAll(".lvl1")).map(s=>level1Marks[s.value]);
  const l2 = Array.from(row.querySelectorAll(".lvl2")).map(s=>level2Marks[s.value]);
  const total = l1.reduce((a,b)=>a+b,0)+l2.reduce((a,b)=>a+b,0);
  await postData("saveMarks", {
    faculty_id, team_id, student_id, batch,
    student_name: row.children[1].textContent,
    dept: row.children[2].textContent,
    venue,
    l1_1: l1[0], l1_2: l1[1], l1_3: l1[2], l1_4: l1[3],
    l2_1: l2[0], l2_2: l2[1], total
  });
  alert(`Marks saved for ${student_id} (${batch} batch).`);
}
</script>
</body>
</html>
